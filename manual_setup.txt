# ğŸŒ NGINX Load Balancer Setup with SSL (Manual Guide) ğŸ¯
# Follow this guide to set up a modular NGINX load balancer with SSL on Ubuntu.

# ğŸš€ Step 1: Install NGINX and Certbot
sudo apt update && sudo apt upgrade -y
sudo apt install nginx -y
sudo apt install certbot python3-certbot-nginx -y

# ğŸ› ï¸ Step 2: Create Modular NGINX Configuration for example.com
sudo nano /etc/nginx/sites-available/example.com

# Add the following content to the file:
upstream example_backend {
    server 192.168.1.10;  # Example backend server 1 ğŸŸ¢
    server 192.168.1.11;  # Example backend server 2 ğŸŸ¢
    server 192.168.1.12;  # Example backend server 3 ğŸŸ¢
}

server {
    listen 80;
    server_name example.com www.example.com;

    # Redirect HTTP to HTTPS ğŸ”’
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name example.com www.example.com;

    # SSL certificates (generated by Certbot) ğŸ“œ
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    # Forward traffic to backend servers ğŸ”€
    location / {
        proxy_pass http://example_backend;
        proxy_set_header Host $host;               # Pass original host header
        proxy_set_header X-Real-IP $remote_addr;   # Client's real IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Forward all client IPs in the proxy chain to the backend
        proxy_set_header X-Forwarded-Proto $scheme;    # Pass the protocol used by the client (http or https)
    }
}

# Save and exit the file (Ctrl+O, Enter, Ctrl+X). âœ…

# ğŸ› ï¸ Step 3: Create Modular NGINX Configuration for api.example.com
sudo nano /etc/nginx/sites-available/api.example.com

# Add the following content to the file:
upstream api_backend {
    server 10.0.0.1;  # Example backend server 1 ğŸŸ¢
    server 10.0.0.2;  # Example backend server 2 ğŸŸ¢
    server 10.0.0.3;  # Example backend server 3 ğŸŸ¢
}

server {
    listen 80;
    server_name api.example.com;

    # Redirect HTTP to HTTPS ğŸ”’
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name api.example.com;

    # SSL certificates (generated by Certbot) ğŸ“œ
    ssl_certificate /etc/letsencrypt/live/api.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.example.com/privkey.pem;

    # Forward traffic to backend servers ğŸ”€
    location / {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;               # Pass original host header
        proxy_set_header X-Real-IP $remote_addr;   # Client's real IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# Save and exit the file (Ctrl+O, Enter, Ctrl+X). âœ…

# ğŸ”— Step 4: Enable Configuration Files
sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/api.example.com /etc/nginx/sites-enabled/

# ğŸ”’ Step 5: Obtain SSL Certificates
sudo certbot --nginx -d example.com -d www.example.com
sudo certbot --nginx -d api.example.com

# ğŸ”„ Step 6: Restart NGINX and Test Configuration
sudo nginx -t  # Test the configuration for errors âœ…
sudo systemctl restart nginx  # Restart NGINX ğŸ”

# ğŸŒŸ Final Step: Verify Your Setup
# Visit your domains to ensure everything is working as expected:
# ğŸ”— https://example.com
# ğŸ”— https://api.example.com

# ğŸ‰ Congratulations! Your modular NGINX load balancer with SSL is ready. ğŸ’ª
